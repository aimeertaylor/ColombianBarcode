
```{r, include = FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, include=FALSE, cache=TRUE, cache.comments = FALSE, 
                      fig.pos = 'H', fig.width = 7, fig.height = 7, dev = 'png', dpi = 300)
```

# Summary of FST analyses

## Previously published FST analyses
Previously published FST estimates were generated at the level of the state using GENALEX6 (Figure \ref{fig: FST previously published}). Echeverry et al. note that "As expected, the lowest differentiation between the provinces was found between Valle-Nariño (FST = 0.023) while the highest was for Cauca–Chocó (FST = 0.117)."

## Re-estimated FST results

### City level

Using Hudson's estimator, I recover estimates that do not vary systematically way with distance (Figure \ref{fig: FST estimates Hudson}).  P-values generated by permutation of city labels suggest significance (Table \ref{tab: pvalues FST estimates Hudson}), as do confidence intervals generated using an independent method of bootstrapping over SNPs (Figure \ref{fig: FST estimates Hudson}). 

The point estimates agree almost perfectly with estimates generated using Weir and Hill's and Weir and Cockerham's estimators (top row, Figure \ref{fig: FST estimators compared city}). The latter are not strongly sensitive to unbalanced sample sizes (bottom left, Figure \ref{fig: FST estimators compared city}). Of those that can be compared with previously published results at the level of the state, estimates do not agree in absolute terms but are highly correlated (bottom right, Figure \ref{fig: FST estimators compared city}). 

### State level
To explore the discrepancy between the previously published results and my estimates, I re-estimated FST at the state level, and compared results with estimates generated using a independent package, DivRsity, which reportedly uses Weir & Cockerham's 1984 estimator. DivRsity estimates almost perfectly match those generated using Hudson's, Wier and Hill's and Wier and Cockerham's estimators (top row and bottom left, Figure \ref{fig: FST estimators compared state}). Absolute values do not agree with previously published results, but the estimates are highly correlated (bottom right, Figure \ref{fig: FST estimators compared state}). Although previously published and re-estimated FST estimates do not agree, because they are highly correlated, the trend with respect to distance is the same based on previously published versus re-estimated FST estimates at the level of the state (Figures \ref{fig: FST previously published} and \ref{fig: new FST estimators state}, respectively). 

```{r}
library(knitr) # For kable
require(gtools) # for combinations
library('diveRsity') # to generate independent estimates of Fst
library('plotrix') # for violine_plot()
source('/Users/aimeet/Documents/BroadLaptop/TM_border/QuantLocalPfConnIBD/FunctionFiles/simtests.R')

# Load geo_dist info and raw data 
load('/Users/aimeet/Documents/BroadLaptop/ColombianBarcode/RData/geo_dist_info.RData')
attach(geo_dist_info)

# Load and summarise raw data 
load('/Users/aimeet/Documents/BroadLaptop/ColombianBarcode/RData/SNPData.RData') 
SNPDataBinary <- SNPData[,6:255] # Extract the SNPData w/o meta data

# Load FST results
load('~/Documents/BroadLaptop/ColombianBarcode/RData/Fst_barcode.RData') 
attach(Fst_barcode, warn.conflicts = FALSE)
comparison_names <- rownames(Pair_wise_site_comparisons_Fst)
numComparisons <- length(comparison_names)
```

```{r, include = TRUE, fig.cap = "\\label{fig: FST previously published} Previously published FST estimates generated using GENALEX 6. No error bars available. Provinces from North to South (with cities in parentheses): Chocó (Tadó and Quibdó), Valle (Buenaventura), Cauca (Guapi), Nariño (Tumaco)."}
#===================================================================
# Existing FST analysis (plotted against inter-state distance)
#===================================================================
# FST copy and pasted from additional file 4
# Cauca	Chocó	Nariño	Valle	 
# 0	 	 	 	             Cauca
# 0.117	0	 	 	         Chocó
# 0.096	0.106	0	 	     Nariño
# 0.073	0.076	0.023	0	 Valle

# As expected, the lowest differentiation between the provinces was found between Valle-Nariño (FST = 0.023) while the highest was for Cauca–Chocó (FST = 0.117) (Additional file 4).

# 1) Input previously published FST estimates (order names to match State_comps below)
FST_state <- c(Cauca_Choco = 0.117,
               Narino_Cauca = 0.096, 
               Narino_Choco = 0.106, 
               Valle_Cauca = 0.073, 
               Valle_Choco = 0.076, 
               Narino_Valle = 0.023)

# Extract city names and successively replace with state names 
City_comps <- names(pairwise_site_distance_all) # These are city names
State_comps <- gsub('Tado', 'Choco', City_comps)
State_comps <- gsub('Quibdo', 'Choco', State_comps)
State_comps <- gsub('Buenaventura', 'Valle', State_comps)
State_comps <- gsub('Guapi', 'Cauca', State_comps)
State_comps <- gsub('Tumaco', 'Narino', State_comps)

# Create Geo_distance store for states (take average distance for Choco where there two cities)
Geo_dist_state = sapply(unique(State_comps), function(x) mean(pairwise_site_distance_all[x == State_comps]))

# Plot existing estimates
par(family = 'serif', mar = c(4,5,1,1))
plot(y = FST_state, x = Geo_dist_state[names(FST_state)], 
     bty = 'n', 
     ylab = expression('Previously published'~hat(F)[ST]^'GENALEX6'), 
     xlab = 'Inter-state distance (km)', bg = 'blue', pch = 21, 
     panel.first = grid())
text(y = FST_state, x = Geo_dist_state[names(FST_state)], 
     labels = gsub('_', ' ', names(FST_state)), pos = c(4,4,2,1,3,4))
```

```{r, include = TRUE, fig.cap= "\\label{fig: FST estimates Hudson} FST estimated at the level of the city using Hudson's estimator."}

#------------------------------------------------------------------
# Multilocus estimates
#------------------------------------------------------------------
par(family = 'serif', mar = c(4,5,1,1))
plot(y = Pair_wise_site_comparisons_Fst, 
     x = pairwise_site_distance_all[comparison_names], 
     bty = 'n', 
     ylab = expression(widehat(F)[ST]^Hudson), 
     xlab = 'Inter-state distance (km)', 
     bg = 'blue', pch = 21, xlim = c(50, 550),   
     panel.first = grid(), ylim = range(Pair_wise_site_comparisons_Fst_CIs))
segments(x0 = pairwise_site_distance_all[comparison_names], x1 = pairwise_site_distance_all[comparison_names],
         y0 = Pair_wise_site_comparisons_Fst_CIs[comparison_names, '2.5%'], 
         y1 = Pair_wise_site_comparisons_Fst_CIs[comparison_names, '97.5%'])
text(y = Pair_wise_site_comparisons_Fst, 
     x = pairwise_site_distance_all[comparison_names], 
     labels = gsub('_', ' ', comparison_names), 
     pos = c(4,3,4,4,4,3,4,4,4,4), cex = 0.5)
abline(h = 0, lty = 'dotted')
```

```{r}
#------------------------------------------------------------------
# SNP wise as violin plots
#------------------------------------------------------------------
par(family = 'serif', mar = c(4,5,1,1))
plot(NULL, xlim = range(pairwise_site_distance_all[comparison_names]), 
     ylim = range(Pair_wise_site_comparisons_Fst_perSNP, na.rm = TRUE), panel.first = grid(),
     ylab = expression('SNP-wise'~widehat(F)[ST]^Hudson), 
     xlab = 'Inter-state distance (km)', )
for(i in comparison_names){
  Z <- Pair_wise_site_comparisons_Fst_perSNP[,i]
  violin_plot(X = Z[!is.na(Z)], col = 'blue', na.rm = TRUE, 
              at = pairwise_site_distance_all[i], add = TRUE, violin_width = 7)
}
points(y = Pair_wise_site_comparisons_Fst, 
       x = pairwise_site_distance_all[comparison_names], pch = 4, cex = 5)
```

```{r, include = TRUE}
#------------------------------------------------------------------
# Extract significance of Fst estimates and tabulate
#------------------------------------------------------------------
# fst results store
fst_significance <- array(dim = c(length(geo_order), 1), 
                          dimnames = list(sapply(strsplit(geo_order, '_'), paste, collapse = ' '), 
                                          'p-value'))

# Averaged over 2001-2010 (all Monte Carlo estimates)
fst_significance[,'p-value'] <- t(apply(matrix(geo_order), 1, function(x){ 
  sim <- Pair_wise_site_comparisons_Fst_Permuted[x,]
  obs <- Pair_wise_site_comparisons_Fst[x]
  pvalue <- mcarlo_rtest(sim, obs)$pvalue_right # as in as.rtest but with n specified
  return(pvalue)
}))

kable(round(fst_significance, 3), caption = '\\label{tab: pvalues FST estimates Hudson} P-values of FST estimated using the Hudson estimator') # non-significant
```


```{r, include = TRUE, fig.width = 10, fig.height = 10, fig.cap= "\\label{fig: FST estimators compared city} City-level FST estimates generated using different estimators."}
#===================================================================
# Generate and plot FST estimates using different estimators
# (quick to calculate because no error bars)
#===================================================================
# 1) Compare estimators 
source('/Users/aimeet/Documents/BroadLaptop/TM_border/QuantLocalPfConnIBD/FunctionFiles/calculate_pairwise_Fst.R')
Pair_wise_site_comparisons <- pairwise_site_distance[,c(1,2)]
estimators <- c('reich', 'WandC', 'WandH', 'GENALEX6')
Pair_wise_site_comparisons_Fst <- array(dim = c(numComparisons, length(estimators)),
                                        dimnames = list(geo_order, estimators))
Sample_size_ratio <- array(dim = numComparisons, dimnames = list(geo_order))

for(i in 1:numComparisons){ 
  
  # Indices for populations to compare
  P1 <- (SNPData$City == as.character(Pair_wise_site_comparisons[i,1]))
  P2 <- (SNPData$City == as.character(Pair_wise_site_comparisons[i,2]))
  Sample_size_ratio[i] <- max(sum(P1)/sum(P2), sum(P2)/sum(P1)) 
  
  # Calculate Fst
  Pair_wise_site_comparisons_Fst[i,'reich'] <- calculate_pairwise_reich(P1, P2, SNPDataBinary)$F_st
  Pair_wise_site_comparisons_Fst[i,'WandC'] <- calculate_pairwise_WandC(P1, P2, SNPDataBinary)$theta_loci_hat_combined
  Pair_wise_site_comparisons_Fst[i,'WandH'] <- calculate_pairwise_WandH(P1, P2, SNPDataBinary)
}

# Add state that do not involve Choco (Tado and Quibdo) by hand
Pair_wise_site_comparisons_Fst['Guapi_Tumaco','GENALEX6'] <- FST_state['Narino_Cauca']
Pair_wise_site_comparisons_Fst['Buenaventura_Guapi','GENALEX6'] <- FST_state['Valle_Cauca']
Pair_wise_site_comparisons_Fst['Buenaventura_Tumaco','GENALEX6'] <- FST_state['Narino_Valle']

# Plot Hudson vs WandH 
par(mfrow = c(2,2), family = 'serif', mar = c(4,5,1,1))
plot(x = Pair_wise_site_comparisons_Fst[,'reich'], 
     y = Pair_wise_site_comparisons_Fst[,'WandH'], 
     xlab = expression(widehat(F)[ST]^Hudson), 
     ylab = expression(widehat(F)[ST]^'Weir and Hill'), 
     bty = 'n', pch = 21, bg = 'gray', panel.first = grid())
abline(a = 0, b = 1, lty = 'dotted')

# Plot Hudson vs W&C
plot(x = Pair_wise_site_comparisons_Fst[,'reich'], 
     y = Pair_wise_site_comparisons_Fst[,'WandC'], 
     xlab = expression(widehat(F)[ST]^Hudson), 
     ylab = expression(widehat(F)[ST]^'Weir and Cockerham'), 
     bty = 'n', pch = 21, bg = 'gray', panel.first = grid())
abline(a = 0, b = 1, lty = 'dotted')

# Plot W&C with sample size difference
plot(y = Pair_wise_site_comparisons_Fst[,'WandC'], 
     x = Sample_size_ratio, 
     xlab = expression(n[1]/n[2]), 
     ylab = expression(F[ST]^'Weir and Cockerham'), bty = 'n', 
     pch = 21, bg = 'gray', panel.first = grid())
CorTest <- cor.test(y = Pair_wise_site_comparisons_Fst[,'WandC'], 
                    x = Sample_size_ratio)
text(y = 0.05, x = 6, labels = sprintf('r = %s (p-value = %s)', 
                                       round(CorTest$estimate, 3),
                                       round(CorTest$p.value, 3)))

# Hudson and GENALEX6 are highly correlated but absolute values don't agree 
plot(x = Pair_wise_site_comparisons_Fst[,'reich'], 
     y = Pair_wise_site_comparisons_Fst[,'GENALEX6'], 
     xlab = expression(widehat(F)[ST]^'Hudson'), 
     ylab = expression(widehat(F)[ST]^'GENALEX6'), 
     bty = 'n', pch = 21, bg = 'gray', panel.first = grid())
CorTest <- cor.test(y = Pair_wise_site_comparisons_Fst[,'reich'], 
                    x = Pair_wise_site_comparisons_Fst[,'GENALEX6'])
text(y = 0.04, x = 0.15, labels = sprintf('r = %s (p-value = %s)', 
                                          round(CorTest$estimate, 4),
                                          round(CorTest$p.value, 3)))
```


```{r, fig.width=10, fig.height=10, include = TRUE, fig.cap= "\\label{fig: FST estimators compared state} State-level FST estimates generated using different estimators."}
#============================================================================
# Estimates at the level of the state
# (quick to calculate because no error bars)
#============================================================================
state_comparisons <- combinations(n = length(unique(SNPData$STATE)), r = 2, unique(SNPData$STATE))
state_order <- apply(state_comparisons, 1, function(x){paste(x[1], x[2], sep = "_")})
estimators <- c('reich', 'WandC', 'WandH', 'GENALEX6', 'DivRsity')
Pair_wise_state_comparisons_Fst <- array(dim = c(length(state_order),length(estimators)),
                                         dimnames = list(state_order, estimators))
Sample_size_ratio <- array(dim = length(state_order),dimnames = list(state_order))

for(i in 1:length(state_order)){
  
  # Indices for populations to compare
  P1 <- (SNPData$STATE == as.character(state_comparisons[i,1]))
  P2 <- (SNPData$STATE == as.character(state_comparisons[i,2]))
  Sample_size_ratio[i] <- max(sum(P1)/sum(P2), sum(P2)/sum(P1)) 
  
  # Calculate Fst
  Pair_wise_state_comparisons_Fst[i,'reich'] <- calculate_pairwise_reich(P1, P2, SNPDataBinary)$F_st
  Pair_wise_state_comparisons_Fst[i,'WandC'] <- calculate_pairwise_WandC(P1, P2, SNPDataBinary)$theta_loci_hat_combined
  Pair_wise_state_comparisons_Fst[i,'WandH'] <- calculate_pairwise_WandH(P1, P2, SNPDataBinary)
}

Pair_wise_state_comparisons_Fst['Cauca_Choco','GENALEX6'] <- FST_state['Cauca_Choco']
Pair_wise_state_comparisons_Fst['Cauca_Narino','GENALEX6'] <- FST_state['Narino_Cauca']
Pair_wise_state_comparisons_Fst['Choco_Narino','GENALEX6'] <- FST_state['Narino_Choco']
Pair_wise_state_comparisons_Fst['Cauca_Valle','GENALEX6'] <- FST_state['Valle_Cauca']
Pair_wise_state_comparisons_Fst['Choco_Valle','GENALEX6'] <- FST_state['Valle_Choco']
Pair_wise_state_comparisons_Fst['Narino_Valle','GENALEX6'] <- FST_state['Narino_Valle']


#===============================================================
# FST Using an indpendendent method (DivRsity package)
# (see diffCalc function example for format)
#===============================================================
Choco_ind <- SNPData$STATE == 'Choco'
Valle_ind <- SNPData$STATE == 'Valle'
Cauca_ind <- SNPData$STATE == 'Cauca'
Narino_ind <- SNPData$STATE == 'Narino'
SNPData_Genepop <- t(apply(SNPDataBinary, 1, as.character))
SNPData_Genepop[SNPData_Genepop == 1] <- '0202'
SNPData_Genepop[SNPData_Genepop == 0] <- '0101'
SNPData_Genepop[is.na(SNPData_Genepop)] <- as.character('0000')
X <- cbind(paste(rownames(SNPData_Genepop), ',', sep = ''), SNPData_Genepop)
Y <- rbind(c(paste(colnames(SNPDataBinary), ',', sep = ''), ''), 
           c('POP', rep('', ncol(SNPDataBinary))),
           X[Choco_ind,], # sid98 
           c('POP', rep('', ncol(SNPDataBinary))),
           X[Valle_ind,], # sid75
           c('POP', rep('', ncol(SNPDataBinary))),
           X[Cauca_ind,], # sid50
           c('POP', rep('', ncol(SNPDataBinary))),
           X[Narino_ind,]) # sid1
write.table(Y, file = 'Colombian_divRsity_data', quote = FALSE, 
            row.names = FALSE, sep = ' ')
test_result <- diffCalc(infile = 'Colombian_divRsity_data', 
                        outfile = "Colombian_divRsity_results",
                        fst = TRUE, pairwise = TRUE, bs_locus = FALSE,
                        bs_pairwise = FALSE, boots = 100, para = TRUE)
Res <- test_result$pairwise$Fst

# Add by hand
Pair_wise_state_comparisons_Fst['Cauca_Choco','DivRsity'] <- Res['sid50,', 'sid98,']
Pair_wise_state_comparisons_Fst['Cauca_Narino','DivRsity'] <- Res['sid1,', 'sid50,']
Pair_wise_state_comparisons_Fst['Choco_Narino','DivRsity'] <- Res['sid1,', 'sid98,']
Pair_wise_state_comparisons_Fst['Cauca_Valle','DivRsity'] <- Res['sid50,', 'sid75,']
Pair_wise_state_comparisons_Fst['Choco_Valle','DivRsity'] <- Res['sid75,', 'sid98,']
Pair_wise_state_comparisons_Fst['Narino_Valle','DivRsity'] <- Res['sid1,', 'sid75,']

#===============================================================
# Plot results
#===============================================================
# Order of magnitude difference between WandC and Reich, but positive correlation.
par(mfrow = c(2,2), family = 'serif',  mar = c(4,5,1,1))
plot(y = Pair_wise_state_comparisons_Fst[,'reich'], 
     x = Pair_wise_state_comparisons_Fst[,'DivRsity'], 
     ylab =  expression(widehat(F)[ST]^'Hudson'), 
     xlab =  expression(widehat(F)[ST]^'DivRsity'), 
     bty = 'n', pch = 21, bg = 'gray', panel.first = grid())
abline(a = 0, b = 1, lty = 'dotted')

# Reich and WandH agree
plot(y = Pair_wise_state_comparisons_Fst[,'WandH'],
     x = Pair_wise_state_comparisons_Fst[,'DivRsity'],
     xlab = expression(widehat(F)[ST]^'DivRsity'),
     ylab = expression(widehat(F)[ST]^'Weir and Hill'), 
     bty = 'n', pch = 21, bg = 'gray', panel.first = grid())
abline(a = 0, b = 1, lty = 'dotted')

# Order of magnitude difference between WandC and Reich, but positive correlation.
plot(y = Pair_wise_state_comparisons_Fst[,'WandC'],
     x = Pair_wise_state_comparisons_Fst[,'DivRsity'],
     xlab = expression(widehat(F)[ST]^'DivRsity'),
     ylab = expression(widehat(F)[ST]^'Weir and Cockerham'), 
     bty = 'n', pch = 21, bg = 'gray', panel.first = grid())
abline(a = 0, b = 1, lty = 'dotted')

# No agreement with previously published even using W&C
plot(y = Pair_wise_state_comparisons_Fst[,'GENALEX6'], 
     x = Pair_wise_state_comparisons_Fst[,'DivRsity'], 
     xlab = expression(widehat(F)[ST]^'DivRsity'), 
     ylab = expression(widehat(F)[ST]^'GENALEX6'),
     bty = 'n', pch = 21, bg = 'gray', panel.first = grid())
CT <- cor.test(y = Pair_wise_state_comparisons_Fst[,'GENALEX6'], 
               x = Pair_wise_state_comparisons_Fst[,'DivRsity'])
legend('topright', legend = sprintf('r = %s (p-value = %s)', round(CT$estimate,3), round(CT$p.value,3)), bty = 'n', cex = 0.6)
```

```{r, include = TRUE, fig.cap= "\\label{fig: new FST estimators state} State-level FST estimates generated using Hudson's estimator plotted with respect to inter-state distance (km)."}
# Plot New state-level estimates. Note that results for Cauca_Narino, Cauca_Valle, and Valle_Narino are as before, while others are now zero. Therefore conclusion based on city-level estimates still stand. 
par(family = 'serif')
plot(y = Pair_wise_state_comparisons_Fst[,'reich'], x = Geo_dist_state[rownames(Pair_wise_state_comparisons_Fst)], 
     bty = 'n', 
     ylab = expression(widehat(F)[ST]^'Hudson'), 
     xlab = 'Inter-state distance (km)',
     bg = 'blue', pch = 21, 
     panel.first = grid())
text(y = Pair_wise_state_comparisons_Fst[,'reich'], 
     x = Geo_dist_state[rownames(Pair_wise_state_comparisons_Fst)], 
     labels = gsub('_', ' ', rownames(Pair_wise_state_comparisons_Fst)), pos = c(4,4,2,2,3,4), cex = 0.75)
abline(h = 0, lty = 'dotted')
```